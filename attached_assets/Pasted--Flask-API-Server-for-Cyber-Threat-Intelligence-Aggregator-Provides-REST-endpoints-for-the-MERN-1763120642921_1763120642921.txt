"""
Flask API Server for Cyber Threat Intelligence Aggregator
Provides REST endpoints for the MERN stack frontend
"""

from flask import Flask, jsonify, request
from flask_cors import CORS
from datetime import datetime
import threading
import time
import json
import os

# Import the fetcher class (assuming it's in the same directory)
from threat_intel_fetcher import ThreatIntelligenceFetcher

app = Flask(__name__)
CORS(app)  # Enable CORS for React frontend

# Global storage for cached threat intelligence
cached_data = {
    'last_updated': None,
    'data': None
}

# Initialize fetcher
fetcher = ThreatIntelligenceFetcher()

# Background update interval (in seconds) - 1 hour
UPDATE_INTERVAL = 3600


def background_fetcher():
    """Background thread to periodically fetch threat intelligence"""
    global cached_data
    
    while True:
        try:
            print(f"[{datetime.now()}] Background fetch started...")
            data = fetcher.fetch_all_feeds()
            
            cached_data['last_updated'] = datetime.now().isoformat()
            cached_data['data'] = data
            
            print(f"[{datetime.now()}] Background fetch completed successfully")
        
        except Exception as e:
            print(f"[{datetime.now()}] Background fetch error: {str(e)}")
        
        # Wait for next update
        time.sleep(UPDATE_INTERVAL)


# ============ API Endpoints ============

@app.route('/api/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    return jsonify({
        'status': 'healthy',
        'timestamp': datetime.now().isoformat(),
        'last_data_update': cached_data['last_updated']
    })


@app.route('/api/threat-intel/all', methods=['GET'])
def get_all_threat_intel():
    """Get all threat intelligence data"""
    if cached_data['data'] is None:
        # First time fetch
        data = fetcher.fetch_all_feeds()
        cached_data['last_updated'] = datetime.now().isoformat()
        cached_data['data'] = data
    
    return jsonify({
        'success': True,
        'last_updated': cached_data['last_updated'],
        'data': cached_data['data']
    })


@app.route('/api/threat-intel/otx', methods=['GET'])
def get_otx_pulses():
    """Get AlienVault OTX pulses"""
    limit = request.args.get('limit', 10, type=int)
    result = fetcher.fetch_otx_pulses(limit=limit)
    return jsonify(result)


@app.route('/api/threat-intel/malware', methods=['GET'])
def get_malware_samples():
    """Get malware samples from Abuse.ch"""
    result = fetcher.fetch_abusech_malware()
    return jsonify(result)


@app.route('/api/threat-intel/malicious-urls', methods=['GET'])
def get_malicious_urls():
    """Get malicious URLs from Abuse.ch"""
    result = fetcher.fetch_abusech_urls()
    return jsonify(result)


@app.route('/api/threat-intel/iocs', methods=['GET'])
def get_iocs():
    """Get IOCs from Abuse.ch ThreatFox"""
    result = fetcher.fetch_abusech_iocs()
    return jsonify(result)


@app.route('/api/threat-intel/phishing', methods=['GET'])
def get_phishing_urls():
    """Get phishing URLs from PhishTank"""
    result = fetcher.fetch_phishtank()
    return jsonify(result)


@app.route('/api/threat-intel/cves', methods=['GET'])
def get_recent_cves():
    """Get recent CVEs from NVD"""
    days = request.args.get('days', 7, type=int)
    result = fetcher.fetch_nvd_recent_cves(days=days)
    return jsonify(result)


@app.route('/api/threat-intel/exploited-cves', methods=['GET'])
def get_exploited_cves():
    """Get CISA's known exploited vulnerabilities"""
    result = fetcher.fetch_cisa_kev()
    return jsonify(result)


@app.route('/api/virustotal/ip/<ip_address>', methods=['GET'])
def check_ip_reputation(ip_address):
    """Check IP reputation via VirusTotal"""
    result = fetcher.fetch_virustotal_ip_report(ip_address)
    return jsonify(result)


@app.route('/api/virustotal/domain/<domain>', methods=['GET'])
def check_domain_reputation(domain):
    """Check domain reputation via VirusTotal"""
    result = fetcher.fetch_virustotal_domain_report(domain)
    return jsonify(result)


@app.route('/api/threat-intel/refresh', methods=['POST'])
def refresh_threat_intel():
    """Manually trigger a refresh of threat intelligence data"""
    try:
        data = fetcher.fetch_all_feeds()
        cached_data['last_updated'] = datetime.now().isoformat()
        cached_data['data'] = data
        
        return jsonify({
            'success': True,
            'message': 'Threat intelligence data refreshed successfully',
            'timestamp': cached_data['last_updated']
        })
    
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/threat-intel/stats', methods=['GET'])
def get_statistics():
    """Get statistics about collected threat intelligence"""
    if cached_data['data'] is None:
        return jsonify({
            'success': False,
            'message': 'No data available yet'
        })
    
    stats = {
        'last_updated': cached_data['last_updated'],
        'sources': {}
    }
    
    # Calculate statistics for each source
    for source_name, source_data in cached_data['data']['sources'].items():
        if source_data.get('success'):
            stats['sources'][source_name] = {
                'count': source_data.get('count', 0),
                'status': 'active'
            }
        else:
            stats['sources'][source_name] = {
                'count': 0,
                'status': 'error',
                'error': source_data.get('error')
            }
    
    # Calculate totals
    stats['totals'] = {
        'total_indicators': sum(s.get('count', 0) for s in stats['sources'].values()),
        'active_sources': sum(1 for s in stats['sources'].values() if s['status'] == 'active'),
        'total_sources': len(stats['sources'])
    }
    
    return jsonify(stats)


@app.route('/api/threat-intel/search', methods=['POST'])
def search_indicators():
    """Search for specific indicators across all sources"""
    if cached_data['data'] is None:
        return jsonify({
            'success': False,
            'message': 'No data available yet'
        })
    
    search_term = request.json.get('query', '').lower()
    search_type = request.json.get('type', 'all')  # ip, domain, hash, cve, all
    
    results = []
    
    # Search through cached data
    for source_name, source_data in cached_data['data']['sources'].items():
        if not source_data.get('success'):
            continue
        
        for item in source_data.get('data', []):
            # Convert item to string for searching
            item_str = json.dumps(item).lower()
            
            if search_term in item_str:
                results.append({
                    'source': source_name,
                    'data': item
                })
    
    return jsonify({
        'success': True,
        'query': search_term,
        'results': results,
        'count': len(results)
    })


@app.route('/api/threat-intel/export', methods=['GET'])
def export_data():
    """Export all threat intelligence data as JSON"""
    if cached_data['data'] is None:
        return jsonify({
            'success': False,
            'message': 'No data available yet'
        })
    
    return jsonify({
        'success': True,
        'exported_at': datetime.now().isoformat(),
        'last_updated': cached_data['last_updated'],
        'data': cached_data['data']
    })


# ============ Error Handlers ============

@app.errorhandler(404)
def not_found(error):
    return jsonify({
        'success': False,
        'error': 'Endpoint not found'
    }), 404


@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        'success': False,
        'error': 'Internal server error'
    }), 500


# ============ Application Startup ============

if __name__ == '__main__':
    # Start background fetcher thread
    fetcher_thread = threading.Thread(target=background_fetcher, daemon=True)
    fetcher_thread.start()
    print("Background threat intelligence fetcher started")
    
    # Run Flask app
    port = int(os.environ.get('PORT', 5000))
    print(f"Starting Flask API server on port {port}...")
    print("\nAvailable endpoints:")
    print("  GET  /api/health - Health check")
    print("  GET  /api/threat-intel/all - Get all threat intelligence")
    print("  GET  /api/threat-intel/otx - Get OTX pulses")
    print("  GET  /api/threat-intel/malware - Get malware samples")
    print("  GET  /api/threat-intel/malicious-urls - Get malicious URLs")
    print("  GET  /api/threat-intel/iocs - Get IOCs")
    print("  GET  /api/threat-intel/phishing - Get phishing URLs")
    print("  GET  /api/threat-intel/cves - Get recent CVEs")
    print("  GET  /api/threat-intel/exploited-cves - Get exploited CVEs")
    print("  GET  /api/virustotal/ip/<ip> - Check IP reputation")
    print("  GET  /api/virustotal/domain/<domain> - Check domain reputation")
    print("  POST /api/threat-intel/refresh - Refresh data")
    print("  GET  /api/threat-intel/stats - Get statistics")
    print("  POST /api/threat-intel/search - Search indicators")
    print("  GET  /api/threat-intel/export - Export all data")
    
    app.run(host='0.0.0.0', port=port, debug=True)